---
title: "tp_serie_temporelle"
output:
  html_document: default
  pdf_document: default
date: "2025-10-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Contexte du TP


```{r, echo=FALSE}
# Gestion des données
if (!require("dplyr")) install.packages("dplyr")
if (!require("tidyr")) install.packages("tidyr")
if (!require("lubridate")) install.packages("lubridate")

# Séries temporelles
if (!require("forecast")) install.packages("forecast")
if (!require("tseries")) install.packages("tseries")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("TSstudio")) install.packages("TSstudio")

# Statistiques descriptives
if (!require("moments")) install.packages("moments")
if (!require("psych")) install.packages("psych")

library(dplyr)
library(tidyr)
library(lubridate)
library(forecast)
library(tseries)
library(ggplot2)
library(gridExtra)
library(moments)
library(psych)

```

```{r, echo = FALSE}

# Chargement des données (remplace "ton_fichier.csv" par le nom de ton fichier)
data <- read.csv("data.csv", stringsAsFactors = FALSE)

# Conversion de la température de Fahrenheit en Celsius
data <- data %>%
  mutate(TAVG = (TAVG..Degrees.Fahrenheit. - 32) / 1.8)

# Conversion de la colonne "Date" en format Date pour M/J/AAAA
data$Date <- as.Date(data$Date, format = "%m/%d/%Y")

# Extraction de l'année et du mois
data <- data %>%
  mutate(Year = year(Date),
         Month = month(Date))

# Calcul de la moyenne mensuelle de TAVG
data <- data %>%
  group_by(Year, Month) %>%
  summarise(TAVG = mean(TAVG, na.rm = TRUE),
            .groups = "drop")

# Affichage du résultat
head(data)

```

```{r, echo = FALSE}
ts_temp<- ts(data$TAVG, start = 1, frequency = 12)
ts_temp
temp_values <- as.numeric(ts_temp)
moyenne <- mean(temp_values, na.rm = TRUE)
mediane <- median(temp_values, na.rm = TRUE)
variance <- var(temp_values, na.rm = TRUE)
skewness <- skewness(temp_values, na.rm = TRUE)
kurtosis <- kurtosis(temp_values, na.rm = TRUE)

```

```{r, echo = FALSE}
cat("\nStatistiques descriptives de la série temporelle :\n")
cat("------------------------------------------------\n")
cat("Moyenne :", round(moyenne, 3), "\n")
cat("Médiane :", round(mediane, 3), "\n")
cat("Variance :", round(variance, 3), "\n")
cat("Skewness :", round(skewness, 3), "\n")
cat("Kurtosis :", round(kurtosis, 3), "\n")
```


```{r, echo = FALSE}

plot(ts_temp,
     main = "Série Temporelle : Température Moyenne Mensuelle",
     ylab = "Température (°C)",
     xlab = "Année",
     col = "steelblue",
     lwd = 2)

mu<- mean(ts_temp)

abline(h = mu, col = "red", lty = 2, lwd = 2)
legend("topleft", legend = "Moyenne", col = "red", lty = 2, lwd = 2, bty = "n")


```
Forme sinusoïdale qui vient de la saisonnalité des températures. 
```{r, echo=FALSE}
# Extraire les mois (1 à 12)
months <- cycle(ts_temp)

df <- data.frame(Month = factor(months, levels = 1:12, labels = month.abb),
                 Temp = as.numeric(ts_temp))

# Tracer les boxplots par mois
ggplot(df, aes(x = Month, y = Temp)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Distribution des températures par mois",
       x = "Mois",
       y = "Température (°C)") +
  theme_minimal()

```

```{r, echo=FALSE}

op <- par(mfrow = c(1,2))
ro <- acf(ts_temp, lag=15, ylim = c(-1,1), main = "ACF empirique")
alpha <- pacf(ts_temp, lag=15, ylim = c(-1,1), main = "et PACF", xlim=c(0,15))
par(op)

```
La série temporelle n'est pas stationnaire 
```{r, echo=FALSE}
# Différenciation simple
ts_diff1 <- diff(ts_temp, differences = 1)

# Différenciation saisonnière
ts_diff_seas <- diff(ts_temp, lag = 12)

# Tests sur séries différenciées
par(mfrow = c(2, 2))
plot(ts_temp, main = "Série Originale", ylab = "Température", col = "blue", lwd = 1.5)
plot(ts_diff1, main = "Différenciation d = 1", ylab = "Diff(Température)", col = "red", lwd = 1.5)
abline(h = 0, lty = 2)
plot(ts_diff_seas, main = "Différenciation Saisonnière (lag=12)", 
     ylab = "Diff(Température)", col = "green4", lwd = 1.5)
abline(h = 0, lty = 2)

# ACF de la série différenciée
acf(ts_diff1, main = "ACF - Série Différenciée (d=1)", lag.max = 36)

# Test ADF sur série différenciée
adf_diff <- adf.test(ts_diff1)
cat("\nTest ADF après différenciation (d=1) :\n")
cat("p-value :", round(adf_diff$p.value, 4), "\n")
```
La différentiationd'ordre 1 n'est pas satisfaisante. Regardons avec lag 12. 
```{r, echo=FALSE}
des_data<- diff(ts_temp, lag=12)
plot(des_data, type='o', main = "série différenciée")
mu <- mean(des_data)
sig.des_data <- sd(des_data)
abline(h=mu, col="red", lwd=2)
abline(h=mu+2*sig.des_data, col="red", lwd=2,lty=2)
abline(h=mu-2*sig.des_data, col="red", lwd=2,lty=2)


```

```{r, echo=FALSE}
op <- par(mfrow = c(1,2))
ro <- acf(des_data, lag=15, ylim = c(-1,1), main = "ACF empirique")
alpha <- pacf(des_data, lag=15, ylim = c(-1,1), main = "et PACF", xlim=c(0,15))
par(op)
```
8.Test de stationnarité
```{r, echo=FALSE}

adf_test <- adf.test(des_data, alternative = "stationary")

print(adf_test)

cat("\nINTERPRÉTATION :\n")
cat("- H0 : la série n'est pas Stationnaire\n")
if (adf_test$p.value > 0.05) {
  cat("- p-value ≥ 0.05 → On NE REJETTE PAS H0\n")
  cat("- ✗ La série n'est pas stationnaire\n\n")
} else {
  cat("- p-value < 0.05 → On REJETTE H0\n")
  cat("- ✓ La série est stationnaire.\n")
}

```
```{r, echo=FALSE}
# Test KPSS
kpss_result <- kpss.test(des_data)
cat("\nTest KPSS sur la série brute :\n")
cat("-------------------------------\n")
cat("Statistique KPSS :", round(kpss_result$statistic, 4), "\n")
cat("p-value :", round(kpss_result$p.value, 4), "\n\n")

if (kpss_result$p.value < 0.05) {
  cat("✗ La série est NON-STATIONNAIRE (p < 0.05)\n")
} else {
  cat("✓ La série est STATIONNAIRE (p ≥ 0.05)\n")
}
```
Partie 2 : Modélisation et analyse 
```{r}
# Sélection automatique avec auto.arima
cat("Sélection automatique du meilleur modèle ARIMA...\n\n")

fit_auto <- auto.arima(des_data,
                       seasonal = TRUE,
                       stepwise = FALSE,
                       approximation = FALSE,
                       trace = TRUE,
                       ic = "aicc")

cat("\n========================================\n")
cat("MEILLEUR MODÈLE SÉLECTIONNÉ\n")
cat("========================================\n")
print(summary(fit_auto))
```
```{r}
# Tester plusieurs modèles manuellement
models <- list(
  "ARIMA(1,1,1)(1,1,1)[12]" = Arima(des_data, order = c(1,1,1), seasonal = c(1,1,1)),
  "ARIMA(2,1,2)(1,1,1)[12]" = Arima(des_data, order = c(2,1,2), seasonal = c(1,1,1)),
  "ARIMA(1,1,2)(2,1,1)[12]" = Arima(des_data, order = c(1,1,2), seasonal = c(2,1,1))
)

# Comparaison des critères
comparison <- data.frame(
  Modèle = names(models),
  AIC = sapply(models, AIC),
  BIC = sapply(models, BIC),
  AICc = sapply(models, function(m) m$aicc),
  LogLik = sapply(models, logLik)
)

comparison <- rbind(
  data.frame(
    Modèle = "Auto ARIMA",
    AIC = AIC(fit_auto),
    BIC = BIC(fit_auto),
    AICc = fit_auto$aicc,
    LogLik = logLik(fit_auto)
  ),
  comparison
)

comparison <- comparison %>% arrange(AICc)

knitr::kable(comparison, 
             caption = "Comparaison des Modèles ARIMA",
             digits = 2)

cat("\n✓ Le meilleur modèle selon AICc est :", comparison$Modèle[1], "\n")
```


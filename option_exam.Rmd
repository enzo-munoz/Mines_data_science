```{r}
# ============================================================================
# CALCULATEUR BLACK-SCHOLES-MERTON POUR OPTIONS EUROPÉENNES
# Portfolio Management avec Delta-Hedging et Volatility Skew
# ============================================================================

# Fonction d'arrondi personnalisée (0.00005 arrondi à 0.0001)
round_custom <- function(x, digits = 4) {
  multiplier <- 10^digits
  result <- floor(x * multiplier + 0.5) / multiplier
  return(result)
}

# ============================================================================
# PARTIE 1: FORMULES BLACK-SCHOLES ET GREEKS
# ============================================================================

# Fonction pour calculer d1 et d2
calculate_d1_d2 <- function(S, K, r, sigma, T) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  d2 <- d1 - sigma*sqrt(T)
  return(list(d1 = d1, d2 = d2))
}

# Prix d'une option Call européenne
call_price <- function(S, K, r, sigma, T) {
  d <- calculate_d1_d2(S, K, r, sigma, T)
  price <- S * pnorm(d$d1) - K * exp(-r*T) * pnorm(d$d2)
  return(price)
}

# Delta d'un Call
call_delta <- function(S, K, r, sigma, T) {
  d <- calculate_d1_d2(S, K, r, sigma, T)
  delta <- pnorm(d$d1)
  return(delta)
}

# Gamma (identique pour Call et Put)
option_gamma <- function(S, K, r, sigma, T) {
  d <- calculate_d1_d2(S, K, r, sigma, T)
  gamma <- dnorm(d$d1) / (S * sigma * sqrt(T))
  return(gamma)
}

# Vega (identique pour Call et Put)
option_vega <- function(S, K, r, sigma, T) {
  d <- calculate_d1_d2(S, K, r, sigma, T)
  vega <- S * dnorm(d$d1) * sqrt(T)
  return(vega)
}

# Theta d'un Call
call_theta <- function(S, K, r, sigma, T) {
  d <- calculate_d1_d2(S, K, r, sigma, T)
  theta <- -(S * dnorm(d$d1) * sigma) / (2 * sqrt(T)) - 
           r * K * exp(-r*T) * pnorm(d$d2)
  return(theta)
}

# ============================================================================
# DONNÉES INITIALES
# ============================================================================

S0 <- 171.01      # Prix initial AAPL
K <- 180          # Strike
r <- 0.03         # Taux d'intérêt annualisé
mu <- 0.05        # Drift (non utilisé pour pricing risque-neutre)
sigma <- 0.10     # Volatilité annualisée
T <- 1            # Maturité en années

cat("============================================================================\n")
cat("DONNÉES DU PROBLÈME\n")
cat("============================================================================\n")
cat("Prix initial (S0):", S0, "\n")
cat("Strike (K):", K, "\n")
cat("Taux sans risque (r):", r, "\n")
cat("Volatilité (sigma):", sigma, "\n")
cat("Maturité (T):", T, "an\n\n")

# ============================================================================
# QUESTION 1: PRIX DU CALL
# ============================================================================

d_values <- calculate_d1_d2(S0, K, r, sigma, T)
cat("Valeurs intermédiaires:\n")
cat("d1 =", round_custom(d_values$d1), "\n")
cat("d2 =", round_custom(d_values$d2), "\n\n")

call_price_0 <- call_price(S0, K, r, sigma, T)
cat("QUESTION 1 - Prix du Call:\n")
cat("C0 =", round_custom(call_price_0), "\n\n")

# ============================================================================
# QUESTION 2: DELTA
# ============================================================================

delta_0 <- call_delta(S0, K, r, sigma, T)
cat("QUESTION 2 - Delta du Call:\n")
cat("Delta =", round_custom(delta_0), "\n")
cat("Interprétation: Delta positif car le Call augmente quand S augmente\n\n")

# ============================================================================
# QUESTION 3: GAMMA
# ============================================================================

gamma_0 <- option_gamma(S0, K, r, sigma, T)
cat("QUESTION 3 - Gamma:\n")
cat("Gamma =", round_custom(gamma_0), "\n")
cat("Interprétation: Gamma positif car Delta augmente avec S (convexité)\n\n")

# ============================================================================
# QUESTION 4: VEGA
# ============================================================================

vega_0 <- option_vega(S0, K, r, sigma, T)
cat("QUESTION 4 - Vega:\n")
cat("Vega =", round_custom(vega_0), "\n")
cat("Interprétation: Vega positif car l'option gagne de la valeur avec volatilité\n\n")

# ============================================================================
# QUESTION 5: THETA
# ============================================================================

theta_0 <- call_theta(S0, K, r, sigma, T)
cat("QUESTION 5 - Theta:\n")
cat("Theta =", round_custom(theta_0), "\n")
cat("Interprétation: Theta négatif car l'option perd de la valeur avec le temps\n\n")

# ============================================================================
# QUESTION 6: VALEUR DU PORTFOLIO DELTA-HEDGÉ
# ============================================================================

portfolio_value_0 <- call_price_0 - delta_0 * S0
cat("QUESTION 6 - Valeur du portfolio (vente Call + achat Delta actions):\n")
cat("Vente Call: +", round_custom(call_price_0), "\n")
cat("Achat", round_custom(delta_0), "actions: -", round_custom(delta_0 * S0), "\n")
cat("Valeur nette =", round_custom(portfolio_value_0), "\n\n")

# ============================================================================
# QUESTIONS 7-8: RE-HEDGING APRÈS 1 MOIS
# ============================================================================

S1 <- 180.2            # Nouveau prix après 1 mois
T1 <- 1 - 1/12         # Temps restant

# Calcul du nouveau Delta
delta_1 <- call_delta(S1, K, r, sigma, T1)
additional_shares <- delta_1 - delta_0

cat("QUESTION 7 - Re-hedging après 1 mois (S =", S1, "):\n")
cat("Nouveau Delta =", round_custom(delta_1), "\n")
cat("Actions supplémentaires à acheter =", round_custom(additional_shares), "\n")
cat("Interprétation: Achat car le prix a augmenté et Delta augmente (Gamma > 0)\n\n")

# Calcul de la variation de valeur du portfolio
call_price_1 <- call_price(S1, K, r, sigma, T1)
pv_factor <- exp(-r * 1/12)  # Actualisation sur 1 mois

# Variation de valeur: nouveau prix - ancien prix actualisé
old_portfolio_pv <- portfolio_value_0 * exp(r * 1/12)  # Valeur future de l'ancien portfolio
new_portfolio_value <- -call_price_1 + delta_1 * S1
change_portfolio <- new_portfolio_value - portfolio_value_0 * exp(r * 1/12)

cat("QUESTION 8 - Changement de valeur du portfolio:\n")
cat("Ancien prix Call:", round_custom(call_price_0), 
    "-> Nouveau:", round_custom(call_price_1), "\n")
cat("Changement =", round_custom(change_portfolio), "\n\n")

# ============================================================================
# PARTIE 2: VOLATILITY SURFACE I
# ============================================================================

cat("============================================================================\n")
cat("PARTIE 2: VOLATILITY SURFACE\n")
cat("============================================================================\n\n")

# QUESTION 9: Portfolio sans volatility skew
K1 <- 180
K2 <- 185

call_K1 <- call_price(S0, K1, r, sigma, T)
call_K2 <- call_price(S0, K2, r, sigma, T)
portfolio_V <- call_K1 - call_K2

cat("QUESTION 9 - Portfolio (Long Call K=180, Short Call K=185):\n")
cat("Prix Call K=180:", round_custom(call_K1), "\n")
cat("Prix Call K=185:", round_custom(call_K2), "\n")
cat("Valeur portfolio V =", round_custom(portfolio_V), "\n\n")

# QUESTION 10: Avec volatility skew
skew_vol <- function(K) {
  vol <- pmin(1, 18/K)
  return(vol)
}

sigma_K1 <- skew_vol(K1)
sigma_K2 <- skew_vol(K2)

call_K1_skew <- call_price(S0, K1, r, sigma_K1, T)
call_K2_skew <- call_price(S0, K2, r, sigma_K2, T)
portfolio_V_prime <- call_K1_skew - call_K2_skew

cat("QUESTION 10 - Portfolio avec volatility skew:\n")
cat("Volatilité K=180:", round_custom(sigma_K1), "\n")
cat("Volatilité K=185:", round_custom(sigma_K2), "\n")
cat("Prix Call K=180:", round_custom(call_K1_skew), "\n")
cat("Prix Call K=185:", round_custom(call_K2_skew), "\n")
cat("Valeur portfolio V' =", round_custom(portfolio_V_prime), "\n")
cat("Différence V' - V =", round_custom(portfolio_V_prime - portfolio_V), "\n")
cat("Interprétation: Volatilité plus élevée pour strikes bas augmente valeur\n\n")

# ============================================================================
# PARTIE 3: DIGITAL OPTIONS
# ============================================================================

cat("============================================================================\n")
cat("PARTIE 3: OPTIONS DIGITALES\n")
cat("============================================================================\n\n")

# Prix d'une option digitale (Cash-or-Nothing avec paiement = 1)
digital_call_price <- function(S, K, r, sigma, T) {
  d <- calculate_d1_d2(S, K, r, sigma, T)
  price <- exp(-r*T) * pnorm(d$d2)
  return(price)
}

# Delta d'une option digitale
digital_call_delta <- function(S, K, r, sigma, T) {
  d <- calculate_d1_d2(S, K, r, sigma, T)
  delta <- exp(-r*T) * dnorm(d$d2) / (S * sigma * sqrt(T))
  return(delta)
}

# QUESTION 11: Prix option digitale
digital_price_180 <- digital_call_price(S0, K, r, sigma, T)

cat("QUESTION 11 - Prix option digitale (K=180):\n")
cat("Prix =", round_custom(digital_price_180), "\n")
cat("Comparaison avec Delta du Call européen:", round_custom(delta_0), "\n")
cat("Relation: Prix digital ≈ e^(-rT) * N(d2), Delta Call = N(d1)\n\n")

# QUESTION 12: Delta-hedge pour digital
digital_delta_180 <- digital_call_delta(S0, K, r, sigma, T)

cat("QUESTION 12 - Delta-hedge de l'option digitale:\n")
cat("Actions à acheter =", round_custom(digital_delta_180), "\n")
cat("Comparaison avec Gamma du Call européen:", round_custom(gamma_0), "\n")
cat("Relation: Delta digital = e^(-rT) * n(d2)/(S*sigma*sqrt(T))\n\n")

# QUESTION 13: Portfolio digital (K=180 long, K=185 short)
digital_price_185 <- digital_call_price(S0, 185, r, sigma, T)
portfolio_W <- digital_price_180 - digital_price_185

cat("QUESTION 13 - Portfolio digital (Long K=180, Short K=185):\n")
cat("Prix digital K=180:", round_custom(digital_price_180), "\n")
cat("Prix digital K=185:", round_custom(digital_price_185), "\n")
cat("Valeur portfolio W =", round_custom(portfolio_W), "\n\n")

# QUESTION 14: Digital avec volatility skew (formule avec chain rule)
digital_call_price_skew <- function(S, K, r, T) {
  sigma_K <- skew_vol(K)
  
  # Calcul des Greeks du Call européen
  C_K <- call_price(S, K, r, sigma_K, T)
  
  # ∂C/∂K (approximation numérique ou formule analytique)
  d <- calculate_d1_d2(S, K, r, sigma_K, T)
  dC_dK <- -exp(-r*T) * pnorm(d$d2)
  
  # ∂C/∂σ = Vega
  vega_K <- option_vega(S, K, r, sigma_K, T)
  
  # ∂σ/∂K pour σ(K) = min{1, 18/K}
  if (18/K < 1) {
    dsigma_dK <- -18/(K^2)
  } else {
    dsigma_dK <- 0
  }
  
  # Prix digital avec chain rule
  digital_price <- -dC_dK - vega_K * dsigma_dK
  
  return(digital_price)
}

digital_180_skew <- digital_call_price_skew(S0, 180, r, T)
digital_185_skew <- digital_call_price_skew(S0, 185, r, T)
portfolio_W_prime <- digital_180_skew - digital_185_skew

cat("QUESTION 14 - Portfolio digital avec volatility skew:\n")
cat("Prix digital K=180 (skew):", round_custom(digital_180_skew), "\n")
cat("Prix digital K=185 (skew):", round_custom(digital_185_skew), "\n")
cat("Valeur portfolio W' =", round_custom(portfolio_W_prime), "\n")
cat("Différence W' - W =", round_custom(portfolio_W_prime - portfolio_W), "\n")
cat("Différence V' - V =", round_custom(portfolio_V_prime - portfolio_V), "\n")
cat("\nAnalyse comparative de l'impact du skew:\n")
cat("Le volatility skew affecte différemment les calls européens et digitaux\n")
cat("car la sensibilité à la volatilité diffère entre ces instruments.\n")

# ============================================================================
# RÉSUMÉ DES RÉSULTATS
# ============================================================================

cat("\n============================================================================\n")
cat("RÉSUMÉ DES RÉPONSES\n")
cat("============================================================================\n")
cat("Q1  - Prix Call:              ", round_custom(call_price_0), "\n")
cat("Q2  - Delta:                  ", round_custom(delta_0), "\n")
cat("Q3  - Gamma:                  ", round_custom(gamma_0), "\n")
cat("Q4  - Vega:                   ", round_custom(vega_0), "\n")
cat("Q5  - Theta:                  ", round_custom(theta_0), "\n")
cat("Q6  - Portfolio initial:      ", round_custom(portfolio_value_0), "\n")
cat("Q7  - Actions à acheter:      ", round_custom(additional_shares), "\n")
cat("Q8  - Changement portfolio:   ", round_custom(change_portfolio), "\n")
cat("Q9  - Portfolio V:            ", round_custom(portfolio_V), "\n")
cat("Q10 - Portfolio V' (skew):    ", round_custom(portfolio_V_prime), "\n")
cat("Q11 - Prix digital K=180:     ", round_custom(digital_price_180), "\n")
cat("Q12 - Delta digital:          ", round_custom(digital_delta_180), "\n")
cat("Q13 - Portfolio W:            ", round_custom(portfolio_W), "\n")
cat("Q14 - Portfolio W' (skew):    ", round_custom(portfolio_W_prime), "\n")
cat("============================================================================\n")
```



5.2142
0.4355
0.02302
67.3305
−5.4443
69.2607
0.2001
-36.0564
1.6743
1.8509
0.3848
0.02187
0.09765
0.1026

```{r}
# Installation et chargement des packages nécessaires
if(!require(nleqslv)) install.packages("nleqslv")
library(nleqslv)

# ==============================================================================
# QUESTION 1: Calcul de la volatilité implicite
# ==============================================================================

# Fonction Black-Scholes pour Call
bs_call <- function(S, K, T, r, sigma) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  d2 <- d1 - sigma*sqrt(T)
  call_price <- S*pnorm(d1) - K*exp(-r*T)*pnorm(d2)
  return(call_price)
}

# Fonction Black-Scholes pour Put
bs_put <- function(S, K, T, r, sigma) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  d2 <- d1 - sigma*sqrt(T)
  put_price <- K*exp(-r*T)*pnorm(-d2) - S*pnorm(-d1)
  return(put_price)
}

# Paramètres Q1
S <- 100
K <- 90
T <- 1
r <- 0.05
call_price_market <- 16.6994

# Calcul de la volatilité implicite par optimisation
objective <- function(sigma) {
  (bs_call(S, K, T, r, sigma) - call_price_market)^2
}

# Optimisation
result <- optimize(objective, interval=c(0.01, 2))
implied_vol_q1 <- result$minimum

cat("=== QUESTION 1 ===\n")
cat("Volatilité implicite:", implied_vol_q1*100, "%\n")
cat("Arrondi à l'entier le plus proche:", round(implied_vol_q1*100), "%\n\n")

# ==============================================================================
# QUESTION 2: Prix du Put avec surface de volatilité
# ==============================================================================

# Fonction de surface de volatilité
sigma_surface <- function(K) {
  0.3 * exp(-2 * (K/100 - 1))
}

# Paramètres Q2
S_q2 <- 100
K_q2 <- 90
T_q2 <- 1
r_q2 <- 0.05

# Calcul de la volatilité pour K=90
sigma_q2 <- sigma_surface(K_q2)
cat("=== QUESTION 2 ===\n")
cat("Volatilité σ(90):", sigma_q2, "\n")

# Prix du Put
put_price_q2 <- bs_put(S_q2, K_q2, T_q2, r_q2, sigma_q2)
cat("Prix du Put:", round(put_price_q2, 2), "\n\n")

# ==============================================================================
# QUESTION 3: Calcul du Delta du Put
# ==============================================================================

# Fonction pour calculer Delta du Put
bs_put_delta <- function(S, K, T, r, sigma) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  delta <- pnorm(d1) - 1
  return(delta)
}

delta_put_q3 <- bs_put_delta(S_q2, K_q2, T_q2, r_q2, sigma_q2)

cat("=== QUESTION 3 ===\n")
cat("Delta du Put:", round(delta_put_q3, 2), "\n\n")

# ==============================================================================
# QUESTION 4: Gain du portfolio hedgé
# ==============================================================================

# Situation initiale
S_init <- 100
put_price_init <- put_price_q2
delta_init <- delta_put_q3

# Portfolio initial: 1 Put + delta actions
portfolio_init <- -put_price_init + delta_init * S_init

cat("=== QUESTION 4 ===\n")
cat("Portfolio initial:\n")
cat("  Prix Put initial:", round(put_price_init, 4), "\n")
cat("  Delta:", round(delta_init, 4), "\n")
cat("  Valeur portfolio:", round(portfolio_init, 4), "\n\n")

# Nouvelle situation: S=95, volatilité +10%
S_new <- 95
sigma_new <- sigma_surface(K_q2) * 1.10

cat("Nouvelle situation:\n")
cat("  Nouveau prix action:", S_new, "\n")
cat("  Nouvelle volatilité:", sigma_new, "\n")

# Nouveau prix du Put
put_price_new <- bs_put(S_new, K_q2, T_q2, r_q2, sigma_new)
cat("  Nouveau prix Put:", round(put_price_new, 4), "\n")

# Valeur du portfolio (delta inchangé)
portfolio_new <- -put_price_new + delta_init * S_new

cat("  Nouvelle valeur portfolio:", round(portfolio_new, 4), "\n")

# Gain
gain_q4 <- portfolio_new - portfolio_init
cat("\nGain du portfolio:", round(gain_q4, 2), "\n\n")

# ==============================================================================
# QUESTION 5: Proportion du changement causé par le prix de l'action
# ==============================================================================

# Changement avec volatilité +10% et S=95
put_price_both <- bs_put(S_new, K_q2, T_q2, r_q2, sigma_new)
change_both <- put_price_both - put_price_init

cat("=== QUESTION 5 ===\n")
cat("Changement avec S=95 et σ+10%:\n")
cat("  Prix Put initial:", round(put_price_init, 4), "\n")
cat("  Prix Put nouveau:", round(put_price_both, 4), "\n")
cat("  Changement total (x):", round(change_both, 4), "\n\n")

# Changement avec seulement S=95 (volatilité inchangée)
sigma_unchanged <- sigma_surface(K_q2)
put_price_price_only <- bs_put(S_new, K_q2, T_q2, r_q2, sigma_unchanged)
change_price_only <- put_price_price_only - put_price_init

cat("Changement avec seulement S=95 (σ inchangé):\n")
cat("  Prix Put initial:", round(put_price_init, 4), "\n")
cat("  Prix Put nouveau:", round(put_price_price_only, 4), "\n")
cat("  Changement dû au prix (y):", round(change_price_only, 4), "\n\n")

# Proportion
proportion_q5 <- change_price_only / change_both

cat("Proportion y/x:", round(proportion_q5, 4), "\n")
cat("Proportion en %:", round(proportion_q5 * 100, 0), "%\n\n")

# ==============================================================================
# RÉSUMÉ DES RÉPONSES
# ==============================================================================

cat("\n")
cat("=" , rep("=", 60), "=\n", sep="")
cat("RÉSUMÉ DES RÉPONSES\n")
cat("=" , rep("=", 60), "=\n", sep="")
cat("Q1 - Volatilité implicite:", round(implied_vol_q1*100), "%\n")
cat("Q2 - Prix du Put:", round(put_price_q2, 2), "\n")
cat("Q3 - Delta du Put:", round(delta_put_q3, 2), "\n")
cat("Q4 - Gain du portfolio:", round(gain_q4, 2), "\n")
cat("Q5 - Proportion y/x:", round(proportion_q5 * 100, 0), "%\n")
cat("=" , rep("=", 60), "=\n", sep="")
```

